<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

        class CountersTable extends HTMLElement {
            static observedAttributes = ["users"];

            constructor() {
                super();
            }

            connectedCallback() {
                this.names = ["adam", "jan"];
                this.users = [];
                this.counters = ["ah", "eh"];
                let table = this.makeTable();
                const shadow = this.attachShadow({mode: "open"});
                shadow.appendChild(table);
            }

            attributeChangedCallback(name, oldValue, newValue) {
                console.log(name, newValue);
            }

            makeHeader() {
                let header = document.createElement("thead");
                let row = document.createElement("tr");
                let name = document.createElement("th");
                name.textContent = "name";
                row.appendChild(name);
                this.counters.forEach(counter => {
                    let cnt = document.createElement("th");
                    cnt.textContent = counter;
                    row.appendChild(cnt);
                });
                let summary = document.createElement("th");
                summary.textContent = "Summary";
                row.appendChild(summary);
                header.appendChild(row);
                return header;
            }

            makeTable() {
                this.setAttribute("id", "counters");
                const table = document.createElement("table");
                table.setAttribute("id", "counters-table");
                table.classList.add("counter-table");
                table.appendChild(this.makeHeader());
                let body = document.createElement("tbody");
                this.names.forEach((name) => {
                    let user = {name: name, counters: this.counters.map((counter) => ({name: counter, value: 0}))};
                    this.users.push(user);
                    let row = this.makeRow(this.users.at(-1));
                    body.appendChild(row);
                });
                table.appendChild(body)
                return table;
            }

            calculateSummary(value, total)
            {
                if(total > 0){
                    return Math.round(value / total * 100);
                }
                return 0;
            }

            updateRow(node, total) {
                let name = node.firstChild.textContent;
                let user = this.users.find(user => user.name === name);
                let userSum = user.counters.reduce((sum, cnt) => sum + cnt.value, 0);
                for (let i = 0; i < user.counters.length; i++) {
                    let counterNode = node.childNodes[i + 1];
                    let fc = counterNode.firstChild.firstChild;
                    fc.textContent = user.counters[i].value;
                    console.log(counterNode);
                }
                let summaryNode = node.lastChild;
                let summaryValue = this.calculateSummary(userSum, total);
                summaryNode.firstChild.textContent = '' + summaryValue + '%';
            }


            updateTable() {
                const el = document.getElementById("counters");
                const table = el.shadowRoot.getElementById("counters-table");
                const body = table.lastChild;
                let total = this.users.reduce((sum, usr) => sum + usr.counters.reduce((sum, cnt) => sum + cnt.value, 0), 0);
                body.childNodes.forEach(node => {
                    this.updateRow(node, total);
                });
            }

            makeRow(user) {
                const row = document.createElement("tr");
                let name = document.createElement("td");
                name.textContent = user.name;
                row.appendChild(name);

                let summaryCell = document.createElement("td");
                summaryCell.textContent = 0;
                summaryCell.setAttribute("id", "summary");
                summaryCell.style = "align: center; text-align: center;";

                let counters = this.makeCounterCells(user, summaryCell);
                counters.forEach((counter) => {
                    let cell = document.createElement("td");
                    cell.appendChild(counter);
                    row.appendChild(cell);
                });
                row.appendChild(summaryCell);
                return row;
            }

            makeButton(label, lambda){
                let button = document.createElement("button");
                button.textContent = label;
                button.addEventListener("click", lambda);
                return button;
            }

            makeCounterCells(user, summaryCell) {
                return user.counters.map((counter, idx) => {
                    let cell = document.createElement("div");
                    cell.setAttribute("id", "counter-value");
                    let value = document.createElement("span");
                    value.style = "display: inline-block;";
                    value.textContent = counter.value;
                    cell.appendChild(value);

                    let buttons = document.createElement("span");
                    buttons.style = "display: inline-block;";
                    let plus = this.makeButton("+",() => {
                            user.counters[idx].value++;
                            this.updateTable();
                        });
                    buttons.appendChild(plus);
                    let minus = this.makeButton("-",() => {
                        user.counters[idx].value--;
                        this.updateTable();
                    });
                    buttons.appendChild(minus);
                    cell.appendChild(buttons)
                    return cell;
                });
            }
        }

        customElements.define('counters-table', CountersTable);
    </script>
</head>
<body>
<counters-table></counters-table>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        :host(.counter-table) {
            border-collapse: collapse;
            border: 1px solid black;
        }
    </style>
    <script>
        const summaryBaseStyle = "align: center; text-align: center;";


        class CountersTable extends HTMLElement {
            static observedAttributes = ["users"];

            constructor() {
                super();
            }

            calculateColor(value) {
                return "background-color: rgba(" + [255 * value / 100, 255 * (100 - value) / 100, 0, 1].join(",") + ")";
            }

            initUsers() {
                this.names.forEach((name) => {
                    this.addUser(name);
                });
            }

            storeState() {
                localStorage.setItem("names", JSON.stringify(this.names));
                localStorage.setItem("counters", JSON.stringify(this.counters));
                localStorage.setItem("users", JSON.stringify(this.users));
            }

            readState(){
                this.names = JSON.parse(localStorage.getItem("names"));
                this.counters = JSON.parse(localStorage.getItem("counters"));
                if (this.counters && this.names) {
                    this.users = JSON.parse(localStorage.getItem("users"));
                } else {
                    this.names = [];
                    this.users = [];
                    this.counters = ["Unnecessary sounds", "Pauses", "Repeats", "Misc"];
                    this.initUsers();
                }
            }

            clearValues(){
                this.users.forEach(user => user.counters.forEach((counter)=>{
                    console.log(counter);
                    counter.value = 0;
                    console.log(counter);
                }));
            }

            clearState(){
                localStorage.clear();
            }

            connectedCallback() {
                this.readState();
                let table = this.makeTable();
                const shadow = this.attachShadow({mode: "open"});
                shadow.appendChild(table);
                this.storeState();
            }

            attributeChangedCallback(name, oldValue, newValue) {
                console.log(name, newValue);
            }

            makeHeader() {
                let header = document.createElement("thead");
                let row = document.createElement("tr");
                let name = document.createElement("th");
                name.textContent = "name";
                row.appendChild(name);
                this.counters.forEach(counter => {
                    let cnt = document.createElement("th");
                    cnt.textContent = counter;
                    row.appendChild(cnt);
                });
                let summary = document.createElement("th");
                summary.textContent = "Summary";
                row.appendChild(summary);
                header.appendChild(row);
                return header;
            }

            addUser(name) {
                let user = {name: name, counters: this.counters.map((counter) => ({name: counter, value: 0}))};
                this.users.push(user);
                this.storeState();
            }

            fillBody(body) {
                this.users.forEach((user) => {
                    let row = this.makeRow(user);
                    body.appendChild(row);
                })
            }

            updateBody(){
                const el = document.getElementById("counters");
                const body = el.shadowRoot.getElementById("counters-body");
                while (body.firstChild) {
                    body.removeChild(body.lastChild);
                }
                this.fillBody(body);
            }

            makeUserAdd(){
                let row = document.createElement("tr");
                let nameCell = document.createElement("th");
                nameCell.setAttribute("colspan", 1 + this.counters.length);
                let input = document.createElement("input");
                input.setAttribute("id", "counters-add-user");
                nameCell.appendChild(input);
                row.appendChild(nameCell);
                let addButton = document.createElement("button");
                addButton.textContent = "Add User";
                addButton.addEventListener("click", () => {
                    const el = document.getElementById("counters");
                    let name = el.shadowRoot.getElementById("counters-add-user").value;
                    this.names.push(name);
                    this.addUser(name);
                    this.updateBody()();
                });
                let buttonCell = document.createElement("th");
                buttonCell.appendChild(addButton);
                row.appendChild(buttonCell);
                return row;
            }

            makeClearValues(){
                let clearValues = document.createElement("button");
                clearValues.textContent = "Clear values";
                clearValues.addEventListener("click",()=>{
                    this.clearValues();
                    this.updateTable();
                });
                return clearValues;
            }

            makeClearState(){
                let clearState = document.createElement("button");
                clearState.textContent = "Clear state";
                clearState.addEventListener("click",()=>{
                    this.clearState();
                    this.readState();
                    this.updateBody();
                    this.updateTable();

                });
                return clearState;
            }

            makeClearButtons(){
                let row = document.createElement("tr");
                let buttons = document.createElement("th");
                buttons.setAttribute("colspan", 2 + this.counters.length);
                let clearValues = this.makeClearValues();
                buttons.appendChild(clearValues);
                let clearState = this.makeClearState();
                buttons.appendChild(clearState);
                row.appendChild(buttons);
                return row;
            }

            makeFooter() {
                let footer = document.createElement("tfoot");
                let userAdd = this.makeUserAdd();
                footer.appendChild(userAdd);
                let clearButtons = this.makeClearButtons();
                footer.appendChild(clearButtons);
                return footer;
            }

            buildTable(table) {
                table.appendChild(this.makeHeader());
                let body = document.createElement("tbody");
                body.setAttribute("id", "counters-body");
                this.fillBody(body);
                table.appendChild(body);
                let footer = this.makeFooter();
                table.appendChild(footer);
            }

            makeTable() {
                this.setAttribute("id", "counters");
                const table = document.createElement("table");
                table.setAttribute("id", "counters-table");
                table.classList.add("counter-table");
                this.buildTable(table);
                return table;
            }

            calculateSummary(value, total) {
                if (total > 0) {
                    return Math.round(value / total * 100);
                }
                return 0;
            }

            calculateUserSum(user) {
                return user.counters.reduce((sum, cnt) => sum + cnt.value, 0);
            }

            printSummary(summaryValue) {
                return '' + summaryValue + '%';
            }

            updateRow(node, total) {
                if (node.name === "TH") {
                    return;
                }
                let name = node.firstChild.textContent;
                let user = this.users.find(user => user.name === name);
                let userSum = this.calculateUserSum(user);
                for (let i = 0; i < user.counters.length; i++) {
                    let counterNode = node.childNodes[i + 1];
                    let fc = counterNode.firstChild.firstChild;
                    fc.textContent = user.counters[i].value;
                }
                let summaryNode = node.lastChild;
                let summaryValue = this.calculateSummary(userSum, total);
                summaryNode.style = summaryBaseStyle + this.calculateColor(summaryValue);
                summaryNode.firstChild.textContent = this.printSummary(summaryValue);
            }

            calculateTotal() {
                return this.users.reduce((sum, usr) => sum + usr.counters.reduce((sum, cnt) => sum + cnt.value, 0), 0);
            }

            updateTable() {
                const el = document.getElementById("counters");
                const body = el.shadowRoot.getElementById("counters-body");
                let total = this.calculateTotal();
                body.childNodes.forEach(node => {
                    this.updateRow(node, total);
                });
            }

            makeRow(user) {
                const row = document.createElement("tr");
                let name = document.createElement("td");
                name.textContent = user.name;
                row.appendChild(name);

                let summaryCell = document.createElement("td");
                let summaryValue = this.calculateSummary(this.calculateUserSum(user), this.calculateTotal());
                summaryCell.textContent = this.printSummary(summaryValue);
                summaryCell.setAttribute("id", "summary");
                summaryCell.style = summaryBaseStyle + this.calculateColor(summaryValue)

                let counters = this.makeCounterCells(user, summaryCell);
                counters.forEach((counter) => {
                    let cell = document.createElement("td");
                    cell.appendChild(counter);
                    row.appendChild(cell);
                });
                row.appendChild(summaryCell);
                return row;
            }

            makeButton(label, lambda) {
                let button = document.createElement("button");
                button.textContent = label;
                button.addEventListener("click", lambda);
                return button;
            }

            makeCounterCells(user, summaryCell) {
                return user.counters.map((counter, idx) => {
                    let cell = document.createElement("div");
                    cell.setAttribute("id", "counter-value");
                    let value = document.createElement("span");
                    value.style = "display: inline-block;";
                    value.textContent = counter.value;
                    cell.appendChild(value);

                    let buttons = document.createElement("span");
                    buttons.style = "display: inline-block;";
                    let plus = this.makeButton("+", () => {
                        user.counters[idx].value++;
                        this.updateTable();
                        this.storeState();
                    });
                    buttons.appendChild(plus);
                    let minus = this.makeButton("-", () => {
                        if (user.counters[idx].value > 0) {
                            user.counters[idx].value--;
                            this.updateTable();
                            this.storeState();
                        }
                    });
                    buttons.appendChild(minus);
                    cell.appendChild(buttons)
                    return cell;
                });
            }
        }

        customElements.define('counters-table', CountersTable);
    </script>
</head>
<body>
<counters-table></counters-table>
</body>
</html>
